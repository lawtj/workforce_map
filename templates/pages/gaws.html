{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
crossorigin=""/>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
crossorigin=""></script>

<script type="text/javascript" src="./static/geojson/papgeo.geojson"></script>

<script src="https://d3js.org/d3.v6.min.js"></script>

<style>.info.legend {
    padding: 6px 8px;
    font: 14px/16px Arial, Helvetica, sans-serif;
    background: white;
    background: rgba(255,255,255,0.9);
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    border-radius: 5px;
    line-height: 18px;
    white-space: nowrap;
}
.info.legend span {
    display: inline-flex;
    align-items: center;
    margin-right: 10px;
}
.info.legend i {
    width: 18px;
    height: 18px;
    margin-right: 5px;
    opacity: 0.7;
}
.legend-caption {
    margin-bottom: 8px;
    font-weight: bold;
    text-align: left;
}
</style>
{% endblock %}

{% block title %}Global Anesthesia Workforce{% endblock %}
{% block content %}

{% set hero_text = "Global Anesthesia Workforce" %}
{% set hero_subtitle = "Number of Physician Anesthesia Providers (PAPs) per 100,000 population" %}

{% include 'includes/hero_subpage.html' with context %}

<div class="container ">
    <div class="columns mt-6 mb-4 is-8">
        <div class="content column is-two-thirds">
            <p class="title is-6 box has-background-success-soft has-text-success-bold"><span class='icon'><i class="fas fa-earth"></i></span>About this map:</p>
            <p>This map shows three layers of anesthesia workforce data. 
                <ul>
                    <li>Number of Physician Anesthesia Providers (PAPs) per 100,000 population</li>
                    <li>Number of Non-Physician Anesthesia Providers (NPAPs) per 100,000 population</li>
                    <li>Number of Physician Anesthesia Providers (PAPs) per 100,000 population in 2016 (per the previous WFSA Workforce Survey)</li>
                    
                </ul>
            </p>
            <p>In 2016, the World Federation of Societies of Anaesthesiologists performed the first survey of the global anesthesia workforce. Data is derived from the Global Anesthesia Workforce Survey published in 2024.</p>

        </div>
        <div class="column">
            <div class="dropdown is-hoverable">
                    <div class="dropdown-trigger">
                        <div class="button ">
                            <span>View citation</span>
            
                            <div class="block ml-3 mr-3">
                                <span class="bulma-arrow-mixin"></span>
                            </div>
                        </div>
                    </div>
                            
            <div class="dropdown-menu">
                <div class="dropdown-content">
                    <div class="dropdown-item "><p class="is-italic has-text-weight-semibold">Law, Tyler J., Michael S. Lipnick, Wayne Morriss, Adrian W. Gelb, et al. 2024. <a href='https://journals.lww.com/anesthesia-analgesia/fulltext/9900/the_global_anesthesia_workforce_survey__updates.788.aspx' target="_blank">“The Global Anesthesia Workforce Survey: Updates and Trends in the Anesthesia Workforce.” </a>Anesthesia & Analgesia, March, 10.1213/ANE.0000000000006836.</p>
                    </div>
                    </div>
                </div>
            </div>
        </div>

    
    </div>
</div>

<div class="container">
    <div class="columns">
        <div class="container column is-three-quarters" id="map" style="height:750px"></div>
        <div class="container column">
            <div class="card">
                <div class="card-header " id="card-header">
                    <div class="card-header-title is-flex is-flex-direction-column " id="card-header-title">
                        <p id="country-name">Select a country to view details</p>
                        <p class="is-size-6" id="country-population"></p>
                    </div>
                </div>
                <div class="card-content" id="country-details" style="display: none;">
                    <!-- Table for displaying country details -->
                    <p class="has-text-weight-semibold has-background-light">Physician Data</p>
                    <table class="table is-fullwidth is-narrow is-hoverable">
                        <tbody>
                            <!-- <tr class='is-light'> -->
                                <!-- <td><strong>Population</strong></td> -->
                                <!-- <td id="country-population"></td> -->
                            <!-- </tr> -->
                            <tr>
                                <td><strong>Total PAPs</strong></td>
                                <td id="country-totalpap"></td>
                            </tr>
                            <tr>
                                <td><strong>Total PAP Density</strong></td>
                                <td id="country-totalpap_cap"></td>
                            </tr>
                            <tr>
                                <td><strong>PAPs in 2016</strong></td>
                                <td id="country-PAP2015"></td>
                            </tr>
                            <tr>
                                <td><strong>PAP Density in 2016</strong></td>
                                <td id="country-pap_density_2015"></td>
                            </tr>
                        </tbody>
                    </table>
                    <p class="has-text-weight-semibold has-background-light">Non-Physician Data</p>
                    <table class="table is-fullwidth is-narrow is-hoverable">
                        <tbody>
                            <tr>
                                <td><strong>Total NPAPs</strong></td>
                                <td id="country-totalnpap"></td>
                            </tr>
                            <tr>
                                <td><strong>Total NPAP Density</strong></td>
                                <td id="country-totalnpap_cap"></td>
                            </tr>
                            <tr>
                                <td><strong>NPAPs in 2016</strong></td>
                                <td id="country-NPAP2015"></td>
                            </tr>
                            <tr>
                                <td><strong>NPAP Density in 2016</strong></td>
                                <td id="country-npap_density_2015"></td>
                            </tr>                            
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
const map = L.map('map').setView([24.653024159812, 15.732421875000002], 3);

const tiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
		maxZoom: 19,
		attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
	}).addTo(map);

function getColor(value) {
    return value >= 20 ? '#4575b4' :
           value >= 15 ? '#91bfdb' :
           value >= 10 ? '#e0f3f8' :
           value >= 5  ? '#ffffbf' :
           value >= 3  ? '#fee090' :
           value >= 1  ? '#fc8d59' :
                         '#d73027'; // for value < 1
}

//style function
function styleGeo(geojson){
    var value = geojson.properties['totalpap_cap'];
    // check if value is null or undefined
    if (value === null || value === undefined || value === "No data") {
        return {
            fillColor: 'black',
            fillOpacity: 0.4,
            color: 'black',
            opacity: 1,
            weight: 1
        };
        
    }
    return{
            fillColor: getColor(value),
            fillOpacity: .7,
            color: 'black',
            opacity: 1,
            weight: 1
        };

}

// Convert Hex to RGBA
function hexToRGBA(hex, opacity) {
    var r = parseInt(hex.slice(1, 3), 16);
    var g = parseInt(hex.slice(3, 5), 16);
    var b = parseInt(hex.slice(5, 7), 16);
    return `rgba(${r}, ${g}, ${b}, ${opacity})`;
}

//what to do on highlight
function highlightGeo(e){
    var layer = e.target;
    layer.setStyle({
        fillOpacity: 0.5,
        weight: 3
    })
};

//what to do on mouseout
function resetGeo(e){
    geojson.resetStyle(e.target);
};
// Process 'Total PAPs' data
function extractProperties(feature) {
    const properties = {
        'population': null,
        'totalpap': null,
        'totalpap_cap': null,
        'physicians2015': null,
        'physicians2015_cap': null,
        'totalnpap': null,
        'totalnpap_cap': null,
        'nurses2015': null,
        'nurses2015_cap': null
    };

    for (const prop in properties) {
        if (feature.properties && feature.properties[prop]) {
            var value = parseFloat(feature.properties[prop]);
            if (!isNaN(value)) {
                if (prop.endsWith('_cap')) { // For per capita values
                    properties[prop] = value.toFixed(2);
                } else { // For population and total number values
                    properties[prop] = value.toLocaleString();
                }
            } else {
                properties[prop] = 'No data';
            }
        } else {
            properties[prop] = 'No data';
        }
    }
    
    return properties;
}

const propertiesToDisplay = {
    'totalpap': 'Total PAPs',
    'totalpap_cap': 'Total PAP Density',
    // Add other properties here
}

function onEachFeature(feature, layer) {
    var featureProperties = extractProperties(feature);

    var tooltipContent = '';

    try{

        // Check for and add the country name
        if (feature.properties && feature.properties['NAME']) {
            tooltipContent += '<strong>Country:</strong> ' + feature.properties['NAME'];
        }
// Loop over each property and add its data
        for (const key in propertiesToDisplay) {
                    tooltipContent += `<br><strong>${propertiesToDisplay[key]}:</strong> `;
                    value = featureProperties[key];
                    tooltipContent += value;
                    // if (key === 'totalpap'){ // if totalpap, i don't want fractional providers. round.
                    //     value = value.toLocaleString();
                    //     tooltipContent += value;
                    // } else if (!isNaN(value) && value != 'No data') { // otherwise, show 2 decimal places
                    //     tooltipContent += value.toFixed(2);
                    // } else {
                    //     tooltipContent += value; // if no data, just show 'No data'
                    // }
                }

        // Bind the constructed tooltip content
        layer.bindTooltip(tooltipContent);

        // Event handlers
        layer.on({
            mouseover: highlightGeo,
            mouseout: resetGeo,
            click: function(e) {
                console.log(featureProperties);
                document.getElementById('country-name').innerHTML = feature.properties['NAME'];
                if (featureProperties['population'] === 'No data' || featureProperties['population'] === null || isNaN(featureProperties['population'])) {
                    document.getElementById('country-population').innerHTML = 'Population: No data';
                } else {
                document.getElementById('country-population').innerHTML = 'Population: '+ (featureProperties['population']/10).toFixed(2) + ' million';
                }
                document.getElementById('country-totalpap').innerHTML = featureProperties['totalpap'].toLocaleString();
                document.getElementById('country-totalpap_cap').innerHTML = featureProperties['totalpap_cap']
                document.getElementById('country-PAP2015').innerHTML = featureProperties['physicians2015'].toLocaleString();
                document.getElementById('country-pap_density_2015').innerHTML = featureProperties['physicians2015_cap']
                document.getElementById('country-totalnpap').innerHTML = featureProperties['totalnpap'].toLocaleString();
                document.getElementById('country-totalnpap_cap').innerHTML = featureProperties['totalnpap_cap']
                document.getElementById('country-NPAP2015').innerHTML = featureProperties['nurses2015'].toLocaleString();
                document.getElementById('country-npap_density_2015').innerHTML = featureProperties['nurses2015_cap']
                document.getElementById('country-details').style.display = '';
                if (featureProperties['totalpap_cap'] === 'No data' || featureProperties['totalpap_cap'] === null || isNaN(featureProperties['totalpap_cap'])) {
                    document.getElementById('card-header').style.backgroundColor = hexToRGBA('black',0.7);
                    document.getElementById('card-header-title').classList.remove('is-size-4')
                } else {
                document.getElementById('card-header').style.backgroundColor = hexToRGBA(getColor(featureProperties['totalpap_cap']),0.7);
                }
                document.getElementById('card-header-title').classList.add('is-size-4')
        }
        });
    } catch (e) {
        console.log('Error on feature: ', feature, 'with value: ', value);
        console.log('Error: ', e);
    }

};


const geojson = L.geoJSON(papData, {
    style: styleGeo,
    onEachFeature: onEachFeature
    }
).addTo(map);

var legend = L.control({ position: 'bottomleft' });

legend.onAdd = function (map) {
    var div = L.DomUtil.create('div', 'info legend'),
        grades = [0, 1, 3, 5, 10, 15, 20],
        labels = [];

        


    // Generate a label with a colored square for each interval
    for (var i = 0; i < grades.length; i++) {
        div.innerHTML +=
            '<span><i style="background:' + getColor(grades[i]) + '"></i> ' +
            (grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] : '+')) + '</span> ';
    }

    div.innerHTML += '<div class="legend-caption">PAP density per 100,000 population</div>';

    return div;
};

legend.addTo(map);


</script>
{% endblock %}